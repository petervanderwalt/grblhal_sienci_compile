name: Build and Deploy Firmware

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install -U platformio requests

      - name: Clone STM32F4xx Driver
        run: git clone --recurse-submodules https://github.com/grblHAL/STM32F4xx.git

      - name: Install 3rd Party Plugins (Online)
        run: |
          mkdir -p STM32F4xx/3rdparty
          cd STM32F4xx/3rdparty
          # Clone the specific plugins requested
          git clone https://github.com/Sienci-Labs/sienci-atci-plugin.git
          git clone https://github.com/Sienci-Labs/grblhal-rgb-plugin.git

      - name: Generate Dynamic PlatformIO Config
        run: python generate_pio_config.py

      - name: Inject Board Definition and Scripts
        run: |
          mkdir -p STM32F4xx/boards
          # Move your custom board definition and renaming script into the driver
          cp genericSTM32F412VG.json STM32F4xx/boards/
          cp extra_script.py STM32F4xx/
          # Ensure any LD scripts in root are available to the build
          cp *.ld STM32F4xx/ 2>/dev/null || true

      - name: Compile All Variants
        working-directory: STM32F4xx
        run: |
          # Build all envs (Stock and ATC) and save log
          pio run 2>&1 | tee build.log

      - name: Prepare Web Directory
        run: |
          mkdir -p public/firmware

          # 1. Copy your existing Web Portal files (UI, DFU logic, etc.)
          cp index.html public/
          cp dfu.js dfuse.js dfu-util.js FileSaver.js public/

          # 2. Collect the Renamed HEX files produced by extra_script.py
          # They are moved to the firmware/ subfolder for the manifest to find
          find STM32F4xx/.pio/build -name "*.hex" -exec cp {} public/firmware/ \;

          # 3. Move the build log to the public root
          cp STM32F4xx/build.log public/build.log

          # 4. Prevent GitHub Pages from ignoring files starting with underscore
          touch public/.nojekyll

      - name: Generate Manifest
        run: python generate_manifest.py

      - name: Upload Artifact (Standard Action Run)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SLB_Firmware_Builds
          path: public/firmware/*.hex

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public
          clean: true
