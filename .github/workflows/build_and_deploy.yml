name: Build GrblHAL Firmware

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# Permissions for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout your repository (contains genericSTM32F412VG.json and config)
      - name: Checkout Custom Config
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Install Dependencies
      - name: Install Dependencies
        run: |
          pip install -U platformio requests

      # 4. Clone the grblHAL STM32F4xx Driver
      - name: Clone STM32F4xx Driver
        run: git clone --recurse-submodules https://github.com/grblHAL/STM32F4xx.git

      # 5. Clone 3rd Party Plugins (Online Repos)
      - name: Install Plugins
        run: |
          mkdir -p STM32F4xx/3rdparty
          cd STM32F4xx/3rdparty

          echo "Cloning Sienci ATCI Plugin..."
          git clone https://github.com/Sienci-Labs/sienci-atci-plugin.git

          echo "Cloning GrblHAL RGB Plugin..."
          git clone https://github.com/Sienci-Labs/grblhal-rgb-plugin.git

      # 6. Generate PlatformIO Config Dynamically
      - name: Generate Dynamic PlatformIO Config
        shell: python
        run: |
          import requests
          import json
          import os

          # URL to the profile
          PROFILE_URL = "https://raw.githubusercontent.com/Sienci-Labs/grblhal-profiles/refs/heads/main/profiles/altmill.json"

          try:
              print(f"Fetching profile from {PROFILE_URL}...")
              response = requests.get(PROFILE_URL)
              response.raise_for_status()
              profile_data = response.json()

              build_flags = []

              # --- ESSENTIAL FLAGS FOR THIS DRIVER/BOARD ---
              # These ensure the STM32F412 HAL and USB stack are active
              build_flags.append("-DSTM32F412Zx")
              build_flags.append("-DUSE_USB_CDC")

              # Keys to ignore from the JSON profile
              ignore_keys = ['info', 'version', 'name', 'description']

              # Parse JSON and create -D flags
              for key, value in profile_data.items():
                  if key not in ignore_keys:
                      if value is True:
                          build_flags.append(f"-D{key}")
                      elif value is False:
                          pass
                      elif isinstance(value, str):
                          # Escape quotes for string definitions
                          build_flags.append(f'-D{key}=\\"{value}\\"')
                      else:
                          build_flags.append(f"-D{key}={value}")

              flags_str = " ".join(build_flags)

              # Generate platformio.ini content
              # Note: 'extra_scripts' is CRITICAL for fixing variant_generic.h errors
              pio_content = f"""
          [platformio]
          src_dir = .
          include_dir = .
          boards_dir = boards

          [env:slb_ext]
          platform = ststm32
          board = genericSTM32F412VG
          framework = arduino

          # Linker script (must exist in repo or be provided)
          board_build.ldscript = STM32F412VGTx_FLASH.ld

          # CRITICAL: Runs grblHAL setup scripts to fix include paths/variants
          extra_scripts = pre:extra_script.py

          # Libraries
          lib_extra_dirs = 3rdparty

          # Build Flags
          build_flags =
              {flags_str}
              -I.

          upload_protocol = dfu
          """

              # Save to STM32F4xx folder
              with open("STM32F4xx/platformio.ini", "w") as f:
                  f.write(pio_content)

              print("Successfully generated STM32F4xx/platformio.ini")
              print("Config Content:\n", pio_content)

          except Exception as e:
              print(f"Error generating config: {e}")
              exit(1)

      # 7. Inject Custom Board Definition and Scripts
      - name: Inject Board Definition
        run: |
          # Copy your custom board definition to the driver's boards folder
          mkdir -p STM32F4xx/boards
          cp genericSTM32F412VG.json STM32F4xx/boards/

          # Ensure extra_script.py is used from the cloned repo,
          # or overwrite it if you have a custom one in your repo root.
          if [ -f "extra_script.py" ]; then
            echo "Copying custom extra_script.py..."
            cp extra_script.py STM32F4xx/
          fi

      # 8. Compile Firmware
      - name: Compile Firmware
        working-directory: STM32F4xx
        run: |
          # Pipe output to log file for the web page
          pio run -e slb_ext 2>&1 | tee build.log

      # 9. Prepare GitHub Pages Content
      - name: Prepare Web Assets
        if: always() # Run even if compile fails (to show log)
        run: |
          mkdir -p public

          # Copy Firmware if it exists
          if [ -f "STM32F4xx/.pio/build/slb_ext/firmware.hex" ]; then
            cp STM32F4xx/.pio/build/slb_ext/firmware.hex public/firmware.hex
            STATUS="Success"
            COLOR="#28a745"
          else
            STATUS="Failed"
            COLOR="#dc3545"
          fi

          # Copy Log
          cp STM32F4xx/build.log public/build_log.txt

          # Generate HTML Index
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
          cat > public/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>AltMill Firmware Build</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
              header { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
              h1 { margin: 0; color: #333; }
              .badge { background: ${COLOR}; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; vertical-align: middle; }
              .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
              .btn { display: inline-block; background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
              .btn:hover { background: #0056b3; }
              .log-container { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; max-height: 600px; overflow-y: auto; }
              pre { margin: 0; }
            </style>
          </head>
          <body>
            <header>
              <h1>AltMill Firmware Builder <span class="badge">${STATUS}</span></h1>
              <p>Last run: ${TIMESTAMP}</p>
            </header>

            <div class="card">
              <h2>Downloads</h2>
              ${STATUS == 'Success' ? '<p>Firmware compiled successfully.</p><a href="firmware.hex" class="btn">Download firmware.hex</a>' : '<p>Build failed. Check the log below.</p>'}
              <br><br>
              <p><small>Profile used: <a href="https://github.com/Sienci-Labs/grblhal-profiles/blob/main/profiles/altmill.json" target="_blank">altmill.json</a></small></p>
            </div>

            <div class="card">
              <h2>Compilation Log</h2>
              <div class="log-container">
                <pre>$(sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' public/build_log.txt)</pre>
              </div>
            </div>
          </body>
          </html>
          EOF

      # 10. Upload Artifact to GitHub Actions Run
      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SLB_EXT_Firmware
          path: public/firmware.hex

      # 11. Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public
