name: Build and Deploy Firmware

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Config Repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: pip install -U platformio

      - name: Clone STM32F4xx Driver
        run: git clone --recurse-submodules https://github.com/grblHAL/STM32F4xx.git

      - name: Inject Board Definitions and Plugins
        run: |
          mkdir -p STM32F4xx/boards
          cp genericSTM32F412VG.json STM32F4xx/boards/
          if [ -d "3rdparty" ]; then cp -r 3rdparty STM32F4xx/; fi
          if [ -f "extra_script.py" ]; then cp extra_script.py STM32F4xx/ ; fi

      # --- BASELINE BUILD (Using your original file) ---
      # This confirms if the linking issue is in the generator or the environment
      - name: Run Baseline Build (Original Config)
        if: hashFiles('platformio.ini.orig') != ''
        working-directory: STM32F4xx
        run: |
          cp ../platformio.ini.orig platformio.ini
          pio run -e slb_ext

      # --- GENERATED BUILD ---
      - name: Generate and Log PlatformIO Config
        run: |
          python generate_pio_config.py
          cat platformio.ini
          cp platformio.ini STM32F4xx/

      - name: Compile All Variants
        working-directory: STM32F4xx
        run: pio run

      - name: Prepare Web Directory
        run: |
          mkdir -p public/firmware
          touch public/.nojekyll
          find STM32F4xx/.pio/build -name "*.hex" -exec cp {} public/firmware/ \;
          if [ -d "web_interface" ]; then cp web_interface/* public/; fi

      - name: Generate JSON Manifest
        run: python generate_manifest.py

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true
