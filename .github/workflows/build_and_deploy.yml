name: Build GrblHAL Firmware

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python Dependencies
        run: pip install -U platformio requests

      - name: Clone STM32F4xx Driver
        run: git clone --recurse-submodules https://github.com/grblHAL/STM32F4xx.git

      - name: Install Plugins
        run: |
          mkdir -p STM32F4xx/3rdparty
          cd STM32F4xx/3rdparty
          git clone https://github.com/Sienci-Labs/sienci-atci-plugin.git
          git clone https://github.com/Sienci-Labs/grblhal-rgb-plugin.git

      # --- HERE IS THE CHANGE: Run the script instead of inline code ---
      - name: Generate PlatformIO Config
        run: python generate_pio_config.py

      - name: Inject Board Definition & Scripts
        run: |
          # 1. Board Definition
          mkdir -p STM32F4xx/boards
          cp genericSTM32F412VG.json STM32F4xx/boards/

          # 2. Extra Script (Required for build)
          if [ -f "extra_script.py" ]; then
             echo "Copying custom extra_script.py..."
             cp extra_script.py STM32F4xx/
          else
             echo "::warning:: extra_script.py not found in root! Build might fail."
          fi

      - name: Compile Firmware
        working-directory: STM32F4xx
        run: pio run -e slb_ext 2>&1 | tee build.log

      - name: Prepare Web Assets
        if: always()
        run: |
          mkdir -p public

          # Handle Firmware File
          if [ -f "STM32F4xx/.pio/build/slb_ext/firmware.hex" ]; then
            cp STM32F4xx/.pio/build/slb_ext/firmware.hex public/firmware.hex
            STATUS="Success"
            COLOR="#28a745"
          else
            STATUS="Failed"
            COLOR="#dc3545"
          fi

          # Handle Log File
          if [ -f "STM32F4xx/build.log" ]; then
            cp STM32F4xx/build.log public/build_log.txt
          else
             echo "Log file not found" > public/build_log.txt
          fi

          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

          # Generate HTML
          cat > public/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>AltMill Firmware Build</title>
            <style>
              body { font-family: system-ui, -apple-system, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f4f4f4; color: #333; }
              .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 10px solid ${COLOR}; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
              .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
              .btn { display: inline-block; background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
              .btn:hover { background: #0056b3; }
              pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; overflow: auto; max-height: 600px; border-radius: 5px; font-size: 0.9em; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Build Status: <span style="color:${COLOR}">${STATUS}</span></h1>
              <p>Completed at: ${TIMESTAMP}</p>
            </div>

            <div class="card">
              <h3>Artifacts</h3>
              ${STATUS == 'Success' ? '<a href="firmware.hex" class="btn">Download Firmware (.hex)</a>' : '<p>Build failed. No firmware generated.</p>'}
              <br><br>
              <p><small>Profile used: <a href="https://github.com/Sienci-Labs/grblhal-profiles/blob/main/profiles/altmill.json">altmill.json</a></small></p>
            </div>

            <div class="card">
              <h3>Compilation Log</h3>
              <!-- Sanitize log output for HTML -->
              <pre>$(sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' public/build_log.txt)</pre>
            </div>
          </body>
          </html>
          EOF

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SLB_EXT_Firmware
          path: public/firmware.hex

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public
